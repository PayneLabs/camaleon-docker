function cama_init_post(t){function a(){for(editor in tinymce.editors){editor=tinymce.editors[editor];$("#"+editor.id).val(tinymce.get(editor.id).getContent()).trigger("change")}return $form.serialize()}$form=$("#form-post"),"true"==t.recover_draft&&$form.css("opacity",0).before('<h2 style="text-align: center">'+I18n("msg.recover")+"</h2>");var e=!1,n=".translate-item",i=t.post_id,s=t.post_draft_id,o=t.post_status,r=t._drafts_path,d=t._posts_path,l=t._ajax_path,f=t._post_tags_path;App_post.save_draft_ajax=function(t,n){e=!0;var o=$form.serializeObject();o._method=s?"patch":"post",o.post_id=i,$form.data("hash")==a()&&n||$.ajax({type:"POST",url:r,data:o,success:function(a){a.error?$.fn.alert({type:"error",title:a.error.join(", "),icon:"times"}):(a._drafts_path&&(r=a._drafts_path),s=a.draft.id,$("#post_draft_id").val(s)),t&&t(a)},dataType:"json",async:!1})},App_post.save_draft=function(){App_post.save_draft_ajax(function(){$form.data("submitted",1),location.href=d+"?flash[notice]="+I18n("msg.draft")})},window.post_editor_draft_intrval&&clearInterval(window.post_editor_draft_intrval),window.post_editor_draft_intrval=setInterval(function(){0==$form.length?clearInterval(window.post_editor_draft_intrval):App_post.save_draft_ajax(null,!0)},6e4),window.save_draft=App_post.save_draft_ajax,0==$form.find(".title-post"+n).size()&&(n=""),$form.find(".title-post"+n).each(function(){function a(t){u.show().find(".sl-link").html(p.replace("__-__",'<span class="sl-url">'+t+"</span>")),u.find(".btn-preview").attr("href",p.replace("__-__",t)+"?draft_id="+s),c.trigger("change_in"),r()}function e(t){_&&_.abort(),_=$.ajax({type:"POST",url:l,data:{method:"exist_slug",slug:t,post_id:i},success:function(t){t.index>0&&(c.addClass("slugify-locked").val(t.slug),a(t.slug))}})}function r(){$("#meta_slug").val($form.find(".slug-post"+n).map(function(){return this.value}).get().join(","))}var d=$(this);if(!d.hasClass("sluged")){if(n)var f=d.attr("data-translation_l"),c=$form.find(".slug-post"+n+'[data-translation_l="'+f+'"]'),p=t._post_urls[f];else var c=$form.find(".slug-post"),p=t._post_urls[Object.keys(t._post_urls)[0]];var u=$('<div class="sl-slug-edit"><strong>'+I18n("msg.permalink")+':&nbsp;</strong><span class="sl-link"></span> <span> &nbsp;&nbsp;</span><a href="#" class="btn btn-default btn-xs btn-edit">'+I18n("button.edit")+'</a> &nbsp;&nbsp; <a href="#" class="btn btn-info btn-xs btn-preview" target="_blank">'+I18n("msg.preview")+'</a> &nbsp;&nbsp; <a href="#" class="btn btn-success btn-xs btn-view" style="display: none" target="_blank">'+I18n("msg.view_page")+"</a></div>").hide();d.addClass("sluged"),d.after(u);var _=null,m=null;c.slugify(d,{change:function(t){m=t,a(t)}}),d.change(function(){m&&e(m)}),c.val()&&(a(c.val()),"published"==o&&u.find(".btn-view").show().attr("href",p.replace("__-__",c.val()))),u.find(".btn-preview").click(function(){var t=$(this);return showLoading(),App_post.save_draft_ajax(function(){hideLoading();var a=t.attr("href").split("draft_id=");a[1]=s;var e=t.clone().hide();e.insertAfter(t).attr("href",a.join("draft_id="))[0].click(),e.remove()}),!1}),u.find(".btn-edit").click(function(){function t(){s.show(),n.show(),o.remove(),i.remove()}var n=$(this),i=$('<a href="#" class="btn btn-default btn-xs btn-edit">'+I18n("button.accept")+'</a> &nbsp; <a href="#"  class="btn-cancel">'+I18n("button.cancel")+"</a>"),s=u.find(".sl-url"),o=$("<input type='text' />").keyup(function(t){if(13==t.keyCode)return i.filter(".btn-edit").click(),!1});return s.hide().after(o),n.hide().after(i),o.val(s.text()),i.filter(".btn-cancel").click(function(){return t(),r(),!1}),i.filter(".btn-edit").click(function(){var n=slugFunc(o.val());return n&&(c.addClass("slugify-locked").val(n),e(n),a(n),t()),!1}),!1})}});try{$(".tinymce_textarea:not(.translated-item)",$form).tinymce().destroy()}catch(t){}tinymce.init(cama_get_tinymce_settings({selector:".tinymce_textarea:not(.translated-item)",height:"480px",base_path:t.base_path})),$form.validate(),$("#post_status").change(function(){$("#post-actions .btn[data-type]").hide(),$('#post-actions .btn[data-type="'+$(this).val()+'"]').show()});var c=function(){var t=$("#form-post > #post_right_bar"),e=t.children(":first"),n=t.offset().top;$(window).scroll(function(){if($(window).width()<1024)return e.css({position:"",width:""}),void t.css("padding-top","");$(window).scrollTop()>=n+10?(e.css({position:"fixed",width:t.width()+"px",top:0,"z-index":4}),t.css("padding-top",e.height()+20)):(e.css({position:"",width:"auto"}),t.css("padding-top",""))}).resize(function(){$(window).width()>=1024&&t.show()}).scroll();var i=$.ajax({type:"GET",url:f,dataType:"json",async:!1}).responseText;$form.find(".tagsinput").tagEditor({autocomplete:{delay:0,position:{collision:"flip"},source:$.parseJSON(i)},forceLowercase:!1,placeholder:I18n("button.add_tag")+"..."}),$form.on("click",".gallery-item-remove",function(){return $("#feature-image").hide(),$("#feature-image input").val(""),!1}),$form.submit(function(){$(this).valid()&&$form.data("submitted",1)}),window.onbeforeunload=function(){if(!$form.data("submitted")&&0!=$("#form-post").length){if($form.data("hash")!=a())return"You sure to leave the page without saving changes?";if($form.data("submitted"))return"You sure to leave the page without saving changes?"}},$form.find("#post_add_new_category").ajax_modal({modal_size:"modal-lg",mode:"iframe",callback:function(t){t.find("iframe").on("load",function(){$(this).contents().find("#main-header, #sidebar-menu, #main-footer").hide(),$(this).contents().find("#admin_content").parent().css("margin-left",0)})},on_close:function(){var t=$form.find("#post_right_bar .list-categories");$.get($form.find("#post_add_new_category").data("reload-url"),{categories:t.find("input:checkbox:checked").map(function(){return $(this).val()}).get()},function(a){t.html(a)})}})};setTimeout(c,1e3),setTimeout(function(){$form.data("hash",a())},2e3),"true"==t.recover_draft&&($form.data("validator").cancelSubmit=!0,$("#post_status").val("published"),$form.submit())}function cama_upload_feature_image(t){$.fn.upload_filemanager($.extend({formats:"image",selected:function(t){var a=t.url;$("#feature-image img").attr("src",a),$("#feature-image input").val(a),$("#feature-image .meta strong").html(t.name),$("#feature-image").show()}},t))}var App_post={},$form=null;